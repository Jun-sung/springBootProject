<footer th:fragment="footer" xmlns:th="http://www.thymeleaf.org">
    <div class="container py-4 border-top mt-auto">
        <p class="text-center text-muted small">&copy; 2026 SafeHome - Hazard Map Real Estate Service</p>
    </div>

    <button class="chat-toggle shadow-lg" onclick="toggleChat()" 
            style="position: fixed; bottom: 30px; right: 30px; background: #1A237E; color: white; border: none; width: 60px; height: 60px; border-radius: 50%; z-index: 3000; font-size: 24px; transition: 0.3s; cursor: pointer;">
        ğŸ’¬
    </button>
    
    <div id="chatbot-sidebar" style="position: fixed; right: -380px; top: 0; width: 380px; height: 100%; background: white; box-shadow: -10px 0 30px rgba(0,0,0,0.15); transition: 0.4s cubic-bezier(0.075, 0.82, 0.165, 1); z-index: 3100; display: flex; flex-direction: column;">
        
        <div style="background: #1A237E; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
            <span class="fw-bold" th:text="#{chat.header}" style="font-size: 1.1rem;">AI ì±„íŒ… ìƒë‹´</span>
            
            <button type="button" onclick="toggleChat()" 
                    style="background: none; border: none; color: white; padding: 10px; margin: -10px; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 3101;">
                <span style="font-size: 1.8rem; line-height: 1;">âœ•</span>
            </button>
        </div>

        <div id="chatBody" style="flex: 1; padding: 20px; overflow-y: auto; background-color: #f8f9fa;">
            <div class="p-2 mb-2 bg-white rounded shadow-sm" style="max-width: 80%;">
                <small class="text-muted d-block mb-1">AI Advisor</small>
                <span th:text="#{chat.welcome}"></span>
            </div>
        </div>

        <div style="padding: 15px; border-top: 1px solid #dee2e6; background: white;">
            <div class="input-group">
                <input type="text" id="chatInput" class="form-control" th:placeholder="#{chat.input.placeholder}" onkeypress="if(event.keyCode==13) sendMessage()">
                <button class="btn btn-primary" style="background:#1A237E; border: none;" type="button" onclick="sendMessage()">
                <span th:text="#{chat.send}"></span>
                </button>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
    function requireLogin() {
      alert([[#{msg.login_required}]]);
      return false; // âœ… ì´ë™ ë§‰ê¸°
    }
    
    function toggleChat() {
        const sidebar = document.getElementById('chatbot-sidebar');
        if (sidebar.style.right === '0px') {
            sidebar.style.right = '-380px';
        } else {
            sidebar.style.right = '0px';
        }
    }

    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const chatBody = document.getElementById('chatBody');
        const message = input.value.trim();

        if (message === "") return;

        // 1. ì‚¬ìš©ì ë©”ì‹œì§€ ì¶œë ¥
        const myMsg = document.createElement('div');
        myMsg.className = 'p-2 mb-2 ms-auto text-white rounded shadow-sm';
        myMsg.style.cssText = 'max-width: 80%; background-color: #0D47A1; word-break: break-all;';
        myMsg.innerHTML = `<span>${message}</span>`;
        chatBody.appendChild(myMsg);

        input.value = "";
        chatBody.scrollTop = chatBody.scrollHeight;

        // 2. ì„œë²„ í˜¸ì¶œ
        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain' // ì„œë²„ ì»¨ë“œë¡¤ëŸ¬ê°€ Stringìœ¼ë¡œ ë°›ëŠ” ê²½ìš° ìœ ì§€
                },
                body: message
            });

            let text = await response.text();

            // [ì¤‘ìš”] Gemini APIê°€ ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡(```json)ì„ í¬í•¨í•´ ì‘ë‹µí•˜ëŠ” ê²½ìš° ëŒ€ë¹„
            if (text.includes("```json")) {
                text = text.split("```json")[1].split("```")[0].trim();
            } else if (text.includes("```")) {
                text = text.split("```")[1].split("```")[0].trim();
            }

            let data;
            try {
                data = JSON.parse(text);
            } catch (e) {
                console.error("Original Text:", text); // ì—ëŸ¬ ë¡œê·¸ í™•ì¸ìš©
                throw new Error("JSON íŒŒì‹± ì‹¤íŒ¨");
            }

            // 3. AI ë‹µë³€ ì¶œë ¥
            const aiMsg = document.createElement('div');
            aiMsg.className = 'p-2 mb-2 bg-white rounded shadow-sm';
            aiMsg.style.cssText = 'max-width: 80%; word-break: break-word;';

            let html = `<small class="text-muted d-block mb-1">AI Advisor</small>`;

            // ì„œë²„ ì‘ë‹µ ê°ì²´ êµ¬ì¡°ì— ë”°ë¥¸ ë¶„ê¸° ì²˜ë¦¬
            if (data && data.recommendedRegions) {
                html += `<div>${data.reason}</div>`;
                html += `<div class="mt-2">`;
                data.recommendedRegions.forEach(region => {
                    html += `
                        <button class="btn btn-sm btn-outline-primary me-1 mb-1"
                            onclick="selectRegion('${region}')">
                            ${region}
                        </button>
                    `;
                });
                html += `</div>`;
            } else if (data && data.content) { 
                // í˜¹ì‹œ ì¶”ì²œ ì§€ì—­ì´ ì—†ëŠ” ì¼ë°˜ ë‹µë³€ì¸ ê²½ìš° ì²˜ë¦¬
                html += `<div>${data.content}</div>`;
            } else {
                html += `<div>ì£„ì†¡í•©ë‹ˆë‹¤. ì ì ˆí•œ ë‹µë³€ì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>`;
            }

            aiMsg.innerHTML = html;
            chatBody.appendChild(aiMsg);
            chatBody.scrollTop = chatBody.scrollHeight;

        } catch (error) {
            console.error(error);
            const errorMsg = document.createElement('div');
            errorMsg.className = 'p-2 mb-2 bg-danger text-white rounded shadow-sm';
            errorMsg.innerText = error.message === "JSON parsing fail" ? "response fail" : "AI Server Connect fail";
            chatBody.appendChild(errorMsg);
            chatBody.scrollTop = chatBody.scrollHeight;
        }
    }


</script>
</footer>